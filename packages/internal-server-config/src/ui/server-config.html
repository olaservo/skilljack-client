<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>Server Configuration</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-tertiary: #0f1729;
      --text: #e8e8e8;
      --text-secondary: #a0a0a0;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --border: #2a2a4a;
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
      --info: #3b82f6;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #e8e8e8;
        --text: #1a1a1a;
        --text-secondary: #666666;
        --border: #e0e0e0;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 12px;
      min-height: 100vh;
      overflow-y: auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .stats {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .add-btn {
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .add-btn:hover {
      background: var(--accent-hover);
    }

    /* Server card */
    .server-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .server-card.disabled {
      opacity: 0.6;
    }

    .server-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      gap: 12px;
    }

    .server-info {
      flex: 1;
      min-width: 0;
    }

    .server-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .server-name {
      font-weight: 600;
      font-size: 14px;
    }

    .status-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: capitalize;
    }

    .status-badge.connected { background: var(--success); color: white; }
    .status-badge.connecting { background: var(--info); color: white; }
    .status-badge.disconnected { background: var(--text-secondary); color: white; }
    .status-badge.unhealthy { background: var(--warning); color: black; }
    .status-badge.restarting { background: var(--info); color: white; }
    .status-badge.failed { background: var(--error); color: white; }
    .status-badge.stopped { background: var(--text-secondary); color: white; }

    .server-command {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'Fira Code', monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .server-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn {
      padding: 4px 8px;
      background: var(--bg-tertiary);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .action-btn:hover {
      background: var(--border);
    }

    .action-btn.danger {
      color: var(--error);
    }

    .action-btn.danger:hover {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }

    .toggle {
      position: relative;
      width: 36px;
      height: 20px;
      flex-shrink: 0;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle input:checked + .toggle-slider {
      background-color: var(--success);
    }

    .toggle input:checked + .toggle-slider:before {
      transform: translateX(16px);
    }

    /* Server details (collapsible) */
    .server-details {
      display: none;
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .server-card.expanded .server-details {
      display: block;
    }

    .detail-row {
      display: flex;
      margin-bottom: 8px;
    }

    .detail-label {
      width: 80px;
      font-size: 11px;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .detail-value {
      font-size: 11px;
      font-family: 'Fira Code', monospace;
      word-break: break-all;
    }

    .env-list {
      font-size: 11px;
      font-family: 'Fira Code', monospace;
    }

    .env-item {
      margin-bottom: 2px;
    }

    .expand-btn {
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
    }

    /* Modal / Form */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .modal-body {
      padding: 16px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Fira Code', monospace;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-hint {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .error {
      text-align: center;
      padding: 40px;
      color: var(--error);
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      z-index: 200;
      display: none;
    }

    .toast.success {
      border-color: var(--success);
      color: var(--success);
    }

    .toast.error {
      border-color: var(--error);
      color: var(--error);
    }

    .toast.visible {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Server Configuration</h1>
      <div class="stats" id="stats">Loading...</div>
    </div>
    <button class="add-btn" onclick="showAddForm()">
      <span>+</span> Add Server
    </button>
  </div>

  <div id="server-list">
    <div class="loading">Loading servers...</div>
  </div>

  <!-- Add/Edit Server Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-title">Add Server</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="server-name">Server Name *</label>
          <input type="text" id="server-name" placeholder="my-server">
          <div class="form-hint">Unique identifier for this server</div>
        </div>
        <div class="form-group">
          <label for="server-command">Command *</label>
          <input type="text" id="server-command" placeholder="npx">
          <div class="form-hint">Command to execute (e.g., npx, node, python)</div>
        </div>
        <div class="form-group">
          <label for="server-args">Arguments</label>
          <input type="text" id="server-args" placeholder="-y @modelcontextprotocol/server-everything">
          <div class="form-hint">Space-separated arguments</div>
        </div>
        <div class="form-group">
          <label for="server-env">Environment Variables</label>
          <textarea id="server-env" rows="3" placeholder="KEY=value&#10;ANOTHER_KEY=value"></textarea>
          <div class="form-hint">One per line: KEY=value</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="modal-submit" onclick="submitForm()">Add Server</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2>Confirm</h2>
        <button class="modal-close" onclick="closeConfirmModal(false)">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-message"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConfirmModal(false)">Cancel</button>
        <button class="btn btn-primary" id="confirm-yes" onclick="closeConfirmModal(true)">Yes, Remove</button>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <script>
    // State
    let servers = [];
    let editingServer = null;
    let useJsonRpc = false;
    let rpcRequestId = 1;
    const pendingRequests = new Map();

    // Get host origin
    const hostOrigin = window.__HOST_ORIGIN__
      || (document.referrer ? new URL(document.referrer).origin : window.location.origin);

    // Detect if we're in an iframe
    const isInIframe = window.parent !== window;

    // Elements
    const serverList = document.getElementById('server-list');
    const stats = document.getElementById('stats');
    const modal = document.getElementById('modal');
    const confirmModal = document.getElementById('confirm-modal');
    const toast = document.getElementById('toast');

    // Confirm modal state
    let confirmCallback = null;

    // ============================================
    // JSON-RPC Communication
    // ============================================

    function sendRpcRequest(method, params = {}) {
      return new Promise((resolve, reject) => {
        const id = rpcRequestId++;
        pendingRequests.set(id, { resolve, reject });

        window.parent.postMessage({
          jsonrpc: '2.0',
          id,
          method,
          params
        }, '*');

        setTimeout(() => {
          if (pendingRequests.has(id)) {
            pendingRequests.delete(id);
            reject(new Error('Request timeout'));
          }
        }, 10000);
      });
    }

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || typeof data !== 'object' || data.jsonrpc !== '2.0') return;

      if (data.id && pendingRequests.has(data.id)) {
        const { resolve, reject } = pendingRequests.get(data.id);
        pendingRequests.delete(data.id);

        if (data.error) {
          reject(new Error(data.error.message || 'RPC error'));
        } else {
          resolve(data.result);
        }
      }
    });

    // ============================================
    // Data Operations
    // ============================================

    async function fetchServers() {
      try {
        let data;
        if (useJsonRpc) {
          data = await sendRpcRequest('server-config/getServers');
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers`);
          if (!res.ok) throw new Error('Failed to fetch servers');
          data = await res.json();
        }
        servers = data.servers || [];
        renderServers();
        updateStats();
      } catch (err) {
        if (!useJsonRpc && isInIframe) {
          console.log('[ServerConfig] HTTP failed, switching to JSON-RPC mode');
          useJsonRpc = true;
          return fetchServers();
        }
        serverList.innerHTML = `<div class="error">Failed to load servers: ${err.message}</div>`;
      }
    }

    async function addServer(config) {
      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/addServer', config);
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config),
          });
          if (!res.ok) throw new Error('Failed to add server');
        }
        showToast('Server added successfully', 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
        throw err;
      }
    }

    async function updateServer(name, config) {
      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/updateServer', { name, ...config });
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers/${encodeURIComponent(name)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config),
          });
          if (!res.ok) throw new Error('Failed to update server');
        }
        showToast('Server updated successfully', 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
        throw err;
      }
    }

    async function removeServer(name) {
      const confirmed = await showConfirmModal(`Are you sure you want to remove "${name}"?`);
      if (!confirmed) return;

      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/removeServer', { name });
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers/${encodeURIComponent(name)}`, {
            method: 'DELETE',
          });
          if (!res.ok) throw new Error('Failed to remove server');
        }
        showToast('Server removed successfully', 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function toggleServerEnabled(name, enabled) {
      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/setServerEnabled', { name, enabled });
        } else {
          await updateServer(name, { enabled });
          return;
        }
        showToast(`Server ${enabled ? 'enabled' : 'disabled'}`, 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
        renderServers(); // Revert UI
      }
    }

    async function restartServer(name) {
      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/restartServer', { name });
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers/${encodeURIComponent(name)}/restart`, {
            method: 'POST',
          });
          if (!res.ok) throw new Error('Failed to restart server');
        }
        showToast('Server restarting...', 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function stopServer(name) {
      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/stopServer', { name });
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers/${encodeURIComponent(name)}/stop`, {
            method: 'POST',
          });
          if (!res.ok) throw new Error('Failed to stop server');
        }
        showToast('Server stopped', 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function startServer(name) {
      try {
        if (useJsonRpc) {
          await sendRpcRequest('server-config/startServer', { name });
        } else {
          const res = await fetch(`${hostOrigin}/api/server-config/servers/${encodeURIComponent(name)}/start`, {
            method: 'POST',
          });
          if (!res.ok) throw new Error('Failed to start server');
        }
        showToast('Server starting...', 'success');
        await fetchServers();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // ============================================
    // UI Rendering
    // ============================================

    function updateStats() {
      const connected = servers.filter(s => s.status === 'connected').length;
      const enabled = servers.filter(s => s.enabled !== false).length;
      stats.textContent = `${connected}/${servers.length} connected, ${enabled}/${servers.length} enabled`;
    }

    function renderServers() {
      if (servers.length === 0) {
        serverList.innerHTML = `
          <div class="empty">
            No servers configured.<br>
            Click "Add Server" to get started.
          </div>
        `;
        return;
      }

      serverList.innerHTML = servers.map(server => {
        const commandLine = server.args?.length
          ? `${server.command} ${server.args.join(' ')}`
          : server.command;

        const envEntries = server.env ? Object.entries(server.env) : [];

        return `
          <div class="server-card ${server.enabled === false ? 'disabled' : ''}" id="card-${escapeHtml(server.name)}">
            <div class="server-header">
              <div class="server-info">
                <div class="server-name-row">
                  <span class="server-name">${escapeHtml(server.name)}</span>
                  <span class="status-badge ${server.status}">${server.status}</span>
                  <span class="expand-btn" onclick="toggleExpand('${escapeJs(server.name)}')">â–¼</span>
                </div>
                <div class="server-command">${escapeHtml(commandLine)}</div>
              </div>
              <div class="server-actions">
                ${server.status === 'stopped' || server.status === 'failed'
                  ? `<button class="action-btn" onclick="startServer('${escapeJs(server.name)}')">Start</button>`
                  : server.status === 'connected' || server.status === 'unhealthy'
                    ? `<button class="action-btn" onclick="restartServer('${escapeJs(server.name)}')">Restart</button>
                       <button class="action-btn" onclick="stopServer('${escapeJs(server.name)}')">Stop</button>`
                    : ''
                }
                <button class="action-btn" onclick="showEditForm('${escapeJs(server.name)}')">Edit</button>
                <button class="action-btn danger" onclick="removeServer('${escapeJs(server.name)}')">Remove</button>
                <label class="toggle">
                  <input type="checkbox"
                         ${server.enabled !== false ? 'checked' : ''}
                         onchange="toggleServerEnabled('${escapeJs(server.name)}', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
            <div class="server-details">
              <div class="detail-row">
                <span class="detail-label">Command:</span>
                <span class="detail-value">${escapeHtml(server.command)}</span>
              </div>
              ${server.args?.length ? `
                <div class="detail-row">
                  <span class="detail-label">Arguments:</span>
                  <span class="detail-value">${escapeHtml(server.args.join(' '))}</span>
                </div>
              ` : ''}
              <div class="detail-row">
                <span class="detail-label">Tools:</span>
                <span class="detail-value">${server.toolCount || 0} tools</span>
              </div>
              ${server.lastError ? `
                <div class="detail-row">
                  <span class="detail-label">Error:</span>
                  <span class="detail-value" style="color: var(--error);">${escapeHtml(server.lastError)}</span>
                </div>
              ` : ''}
              ${envEntries.length ? `
                <div class="detail-row">
                  <span class="detail-label">Env:</span>
                  <div class="env-list">
                    ${envEntries.map(([k, v]) => `<div class="env-item">${escapeHtml(k)}=${escapeHtml(v)}</div>`).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleExpand(name) {
      // Use escapeHtml to match the ID format used in renderServers
      const card = document.getElementById(`card-${escapeHtml(name)}`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    // ============================================
    // Modal / Form
    // ============================================

    function showAddForm() {
      editingServer = null;
      document.getElementById('modal-title').textContent = 'Add Server';
      document.getElementById('modal-submit').textContent = 'Add Server';
      document.getElementById('server-name').value = '';
      document.getElementById('server-name').disabled = false;
      document.getElementById('server-command').value = '';
      document.getElementById('server-args').value = '';
      document.getElementById('server-env').value = '';
      modal.classList.add('active');
    }

    function showEditForm(name) {
      const server = servers.find(s => s.name === name);
      if (!server) return;

      editingServer = name;
      document.getElementById('modal-title').textContent = 'Edit Server';
      document.getElementById('modal-submit').textContent = 'Save Changes';
      document.getElementById('server-name').value = server.name;
      document.getElementById('server-name').disabled = true;
      document.getElementById('server-command').value = server.command || '';
      document.getElementById('server-args').value = (server.args || []).join(' ');
      document.getElementById('server-env').value = server.env
        ? Object.entries(server.env).map(([k, v]) => `${k}=${v}`).join('\n')
        : '';
      modal.classList.add('active');
    }

    function closeModal() {
      modal.classList.remove('active');
      editingServer = null;
    }

    function showConfirmModal(message) {
      return new Promise((resolve) => {
        document.getElementById('confirm-message').textContent = message;
        confirmCallback = resolve;
        confirmModal.classList.add('active');
      });
    }

    function closeConfirmModal(result) {
      confirmModal.classList.remove('active');
      if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
      }
    }

    async function submitForm() {
      const name = document.getElementById('server-name').value.trim();
      const command = document.getElementById('server-command').value.trim();
      const argsStr = document.getElementById('server-args').value.trim();
      const envStr = document.getElementById('server-env').value.trim();

      if (!name || !command) {
        showToast('Name and command are required', 'error');
        return;
      }

      // Parse args
      const args = argsStr ? argsStr.split(/\s+/).filter(Boolean) : [];

      // Parse env
      const env = {};
      if (envStr) {
        for (const line of envStr.split('\n')) {
          const [key, ...rest] = line.split('=');
          if (key && rest.length) {
            env[key.trim()] = rest.join('=').trim();
          }
        }
      }

      try {
        if (editingServer) {
          await updateServer(editingServer, { command, args, env: Object.keys(env).length ? env : undefined });
        } else {
          await addServer({ name, command, args, env: Object.keys(env).length ? env : undefined });
        }
        closeModal();
      } catch (err) {
        // Error already shown via toast
      }
    }

    // ============================================
    // Toast
    // ============================================

    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = `toast ${type} visible`;
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 3000);
    }

    // ============================================
    // Utilities
    // ============================================

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[c]);
    }

    function escapeJs(str) {
      if (!str) return '';
      return String(str).replace(/[\\'"]/g, '\\$&');
    }

    // ============================================
    // Initialize
    // ============================================

    if (isInIframe) {
      console.log('[ServerConfig] Running in iframe, using JSON-RPC mode');
      useJsonRpc = true;
    }

    fetchServers();

    // Auto-refresh every 5 seconds
    setInterval(fetchServers, 5000);
  </script>
</body>
</html>
